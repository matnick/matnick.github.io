<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Документация разработчика</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.c0e87e78.css" as="style"><link rel="preload" href="/assets/js/app.a697d354.js" as="script"><link rel="preload" href="/assets/js/6.e7415cd1.js" as="script"><link rel="prefetch" href="/assets/js/9.f05aaa51.js"><link rel="prefetch" href="/assets/js/2.cda51ec0.js"><link rel="prefetch" href="/assets/js/3.977aea16.js"><link rel="prefetch" href="/assets/js/4.6f249020.js"><link rel="prefetch" href="/assets/js/5.f8253c46.js"><link rel="prefetch" href="/assets/js/7.04dd9be0.js"><link rel="prefetch" href="/assets/js/8.6719a07d.js"><link rel="prefetch" href="/assets/js/10.be540ae0.js"><link rel="prefetch" href="/assets/js/11.aa3da543.js"><link rel="prefetch" href="/assets/js/12.03212805.js"><link rel="prefetch" href="/assets/js/13.c2de9d92.js"><link rel="prefetch" href="/assets/js/14.730bb09a.js"><link rel="prefetch" href="/assets/js/15.58f8f9a5.js"><link rel="prefetch" href="/assets/js/16.196268a0.js"><link rel="prefetch" href="/assets/js/17.a87b1c38.js"><link rel="prefetch" href="/assets/js/18.ba830e3d.js"><link rel="prefetch" href="/assets/js/19.4dd3afd9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c0e87e78.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="" class="logo"> <!----></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Основная информация</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/what_glue.html" class="nav-link">Что такое GLUE</a></li><li class="dropdown-item"><!----> <a href="/start.html" class="nav-link">Запуск системы</a></li><li class="dropdown-item"><!----> <a href="/panel.html" class="nav-link">Панель управления</a></li><li class="dropdown-item"><!----> <a href="/scripts_and_drivers.html" class="nav-link">Скрипты и драйвера</a></li><li class="dropdown-item"><!----> <a href="/logs.html" class="nav-link">Система логов</a></li><li class="dropdown-item"><!----> <a href="/bus.html" class="nav-link">Общая шина</a></li><li class="dropdown-item"><!----> <a href="/impact.html" class="nav-link">Nokia IMPACT</a></li><li class="dropdown-item"><!----> <a href="/lua.html" class="nav-link">Язык Lua</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Документация</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/panel.html" class="nav-link">Панель управления</a></li><li class="dropdown-item"><!----> <a href="/developers.html" class="nav-link router-link-exact-active router-link-active">Руководство разработчика</a></li><li class="dropdown-item"><!----> <a href="/inside.html" class="nav-link">Внутренности системы</a></li><li class="dropdown-item"><!----> <a href="/changelog.html" class="nav-link">История изменений</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Примеры</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/examples_driver.html" class="nav-link">Драйвера</a></li><li class="dropdown-item"><!----> <a href="/examples_bus_event.html" class="nav-link">Bus-event скрипты</a></li><li class="dropdown-item"><!----> <a href="/examples_web_event.html" class="nav-link">Web-event скрипты</a></li><li class="dropdown-item"><!----> <a href="/examples_timer_event.html" class="nav-link">Timer-event скрипты</a></li><li class="dropdown-item"><!----> <a href="/examples_shedule_event.html" class="nav-link">Shedule-event скрипты</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Основная информация</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/what_glue.html" class="nav-link">Что такое GLUE</a></li><li class="dropdown-item"><!----> <a href="/start.html" class="nav-link">Запуск системы</a></li><li class="dropdown-item"><!----> <a href="/panel.html" class="nav-link">Панель управления</a></li><li class="dropdown-item"><!----> <a href="/scripts_and_drivers.html" class="nav-link">Скрипты и драйвера</a></li><li class="dropdown-item"><!----> <a href="/logs.html" class="nav-link">Система логов</a></li><li class="dropdown-item"><!----> <a href="/bus.html" class="nav-link">Общая шина</a></li><li class="dropdown-item"><!----> <a href="/impact.html" class="nav-link">Nokia IMPACT</a></li><li class="dropdown-item"><!----> <a href="/lua.html" class="nav-link">Язык Lua</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Документация</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/panel.html" class="nav-link">Панель управления</a></li><li class="dropdown-item"><!----> <a href="/developers.html" class="nav-link router-link-exact-active router-link-active">Руководство разработчика</a></li><li class="dropdown-item"><!----> <a href="/inside.html" class="nav-link">Внутренности системы</a></li><li class="dropdown-item"><!----> <a href="/changelog.html" class="nav-link">История изменений</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Примеры</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/examples_driver.html" class="nav-link">Драйвера</a></li><li class="dropdown-item"><!----> <a href="/examples_bus_event.html" class="nav-link">Bus-event скрипты</a></li><li class="dropdown-item"><!----> <a href="/examples_web_event.html" class="nav-link">Web-event скрипты</a></li><li class="dropdown-item"><!----> <a href="/examples_timer_event.html" class="nav-link">Timer-event скрипты</a></li><li class="dropdown-item"><!----> <a href="/examples_shedule_event.html" class="nav-link">Shedule-event скрипты</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Документация разработчика</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/developers.html#общая-информация" class="sidebar-link">Общая информация</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/developers.html#внутренние-переменные-скрипта" class="sidebar-link">Внутренние переменные скрипта</a></li><li class="sidebar-sub-header"><a href="/developers.html#функции-дnя-работы-с-nогами" class="sidebar-link">Функции для работы с логами</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/developers.html#функции-log-info-log-warning-log-error-log-user" class="sidebar-link">Функции loginfo(), logwarning(), logerror(), loguser()</a></li><li class="sidebar-sub-header"><a href="/developers.html#функции-log-и-print" class="sidebar-link">Функции log() и print()</a></li></ul></li><li class="sidebar-sub-header"><a href="/developers.html#функции-дnя-работы-с-центраnьной-шиной" class="sidebar-link">Функции для работы с центральной шиной</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/developers.html#функция-set-value" class="sidebar-link">Функция set_value()</a></li><li class="sidebar-sub-header"><a href="/developers.html#функция-shadow-set-value" class="sidebar-link">Функция shadowsetvalue()</a></li><li class="sidebar-sub-header"><a href="/developers.html#функция-get-value" class="sidebar-link">Функция get_value()</a></li><li class="sidebar-sub-header"><a href="/developers.html#функция-bus-serialize" class="sidebar-link">Функция bus_serialize()</a></li></ul></li><li class="sidebar-sub-header"><a href="/developers.html#вспомогатеnьные-функции" class="sidebar-link">Вспомогательные функции</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/developers.html#функция-round" class="sidebar-link">Функция round()</a></li><li class="sidebar-sub-header"><a href="/developers.html#функция-deepcopy" class="sidebar-link">Функция deepcopy()</a></li></ul></li><li class="sidebar-sub-header"><a href="/developers.html#встроенные-бибnиотеки" class="sidebar-link">Встроенные библиотеки</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/developers.html#бибnиотека-http-client" class="sidebar-link">Библиотека HTTP Client</a></li><li class="sidebar-sub-header"><a href="/developers.html#бибnиотека-mqtt" class="sidebar-link">Библиотека MQTT</a></li><li class="sidebar-sub-header"><a href="/developers.html#бибnиотека-json" class="sidebar-link">Библиотека JSON</a></li><li class="sidebar-sub-header"><a href="/developers.html#бибnиотека-socket" class="sidebar-link">Библиотека Socket</a></li><li class="sidebar-sub-header"><a href="/developers.html#бибnиотека-fiber" class="sidebar-link">Библиотека Fiber</a></li></ul></li></ul></li><li><a href="/developers.html#скрипты-и-драйвера" class="sidebar-link">Скрипты и драйвера</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/developers.html#drivers" class="sidebar-link">Drivers</a></li><li class="sidebar-sub-header"><a href="/developers.html#bus-event-scripts" class="sidebar-link">Bus-event scripts</a></li><li class="sidebar-sub-header"><a href="/developers.html#web-event-scripts" class="sidebar-link">Web-event scripts</a></li><li class="sidebar-sub-header"><a href="/developers.html#timer-event-scripts" class="sidebar-link">Timer-event scripts</a></li><li class="sidebar-sub-header"><a href="/developers.html#schedule-scripts" class="sidebar-link">Schedule scripts</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="документация-разработчика"><a href="#документация-разработчика" aria-hidden="true" class="header-anchor">#</a> Документация разработчика</h1> <h2 id="общая-информация"><a href="#общая-информация" aria-hidden="true" class="header-anchor">#</a> Общая информация</h2> <h3 id="внутренние-переменные-скрипта"><a href="#внутренние-переменные-скрипта" aria-hidden="true" class="header-anchor">#</a> Внутренние переменные скрипта</h3> <p><code>_script_name</code> - переменная, содержащая название текущего скрипта<br> <code>_script_uuid</code> -  переменная, содержащая uuid (уникальный идентификатор) текущего скрипта<br> <code>store</code> - таблица для хранения временных данных, уникальная для каждого скрипта. Ее можно использовать просто как переменную:</p> <div class="language-lua extra-class"><pre class="language-lua"><code>store<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">5</span>
<span class="token function">print</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token comment">-- 5</span>
</code></pre></div><p><code>main_store</code> - таблица, в которой находятся хранилища всех запущенных с момента запуска системы скриптов.<br>
Первый уровень таблицы — UUID скриптов. Второй уровень — store каждого скрипта. UUID скрипта можно узнать, нажав на значок &quot;i&quot; в интерфейсе. С помощью этой таблицы можно получать доступ к хранилищам других скриптов:</p> <div class="language-lua extra-class"><pre class="language-lua"><code>store<span class="token punctuation">.</span>table <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">}</span>
<span class="token function">print</span><span class="token punctuation">(</span>main_store<span class="token punctuation">[</span><span class="token string">&quot;8d72fe2f-801e-48d1-ac1a-526f3e2622c0&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>table<span class="token punctuation">)</span> <span class="token comment">-- { 1, 2, 3, 4, 5 }</span>
</code></pre></div><p>Например, это позволяет передавать между скриптами функции или таблицы, которые нельзя напрямую передать через BUS.</p> <h3 id="функции-дnя-работы-с-nогами"><a href="#функции-дnя-работы-с-nогами" aria-hidden="true" class="header-anchor">#</a> Функции для работы с логами</h3> <h4 id="функции-log-info-log-warning-log-error-log-user"><a href="#функции-log-info-log-warning-log-error-log-user" aria-hidden="true" class="header-anchor">#</a> Функции log_info(), log_warning(), log_error(), log_user()</h4> <p>Добавляют в системный лог запись уровня &quot;INFO&quot;, &quot;WARNING&quot;, &quot;ERROR&quot; и &quot;USER&quot; соответственно.<br>
Использование: <code>log_info(&quot;Found correlation!&quot;)</code>, <code>log_warning(&quot;Found correlation!&quot;)</code> , <code>log_error(&quot;Found correlation!&quot;)</code> , <code>log_user(&quot;Found correlation!&quot;)</code>
Ничего не возвращает.</p> <h4 id="функции-log-и-print"><a href="#функции-log-и-print" aria-hidden="true" class="header-anchor">#</a> Функции log() и print()</h4> <p><code>log()</code> - алиас для функции log_user()<br> <code>print()</code> - алиас для функции log_user()</p> <h3 id="функции-дnя-работы-с-центраnьной-шиной"><a href="#функции-дnя-работы-с-центраnьной-шиной" aria-hidden="true" class="header-anchor">#</a> Функции для работы с центральной шиной</h3> <h4 id="функция-set-value"><a href="#функция-set-value" aria-hidden="true" class="header-anchor">#</a> Функция set_value()</h4> <p>Обновляет топик &quot;topic&quot;, устанавливая значение &quot;value&quot;.<br>
Использование: <code>set_value(topic, value, check_flag, update_time)</code><br>
Ничего не возвращает.</p> <p>Параметр <strong>check_flag</strong> определяет, будет ли проверяться перед изменением значение изменяемого топика.<br>
Если параметр check_flag равен &quot;CHECK_VALUE&quot;, то функция проверит равенство передаваемого в нее значение и старого значения в топике, и если они равны — не будет обновлять топик(т.е. не будут запущены событийные скрипты, и не будет обновлено время обновления топика). Если параметр равен чему-то другому (или не передается вообще, т.е. равен nil), то проверки производиться не будет, и значение топика будет обновлено в любом случае.<br>
Это поведение используется для случаев, когда функции могут вернуть значение, равное значению топика, и логика работы такова, что при этом нет необходимости активировать событийные скрипты.</p> <p>Параметр <strong>update_time</strong> переопределяет время обновления топика. Если update_time не указано, используется текущее системное время. Формат update_time — unix-time в секундах текущего часового пояса, допускаются десятые, сотые и тысячные доли.<br>
Это поведение используется, например, если в драйвере запрашиваются исторические данные через API и необходимо, чтобы в выгрузку в TSDB они ушли с временем из истории, а не с текущим. Тогда в BUS загружаются исторические данные, используя параметр update_time, и они с этим временем выгружаются в TSDB.<br>
Обратите внимание, что поле Update time в bus storage в этом случае не будет соответствовать реальности — несмотря на то, что топик был обновлен только что, время обновления в интерфейсе будет равно переданному в set_value параметру update_time.</p> <p>Примеры использования:</p> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token function">set_value</span><span class="token punctuation">(</span><span class="token string">&quot;/test/device&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;5&quot;</span><span class="token punctuation">)</span>
<span class="token function">set_value</span><span class="token punctuation">(</span><span class="token string">&quot;/test/device&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;5&quot;</span><span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span>
<span class="token function">set_value</span><span class="token punctuation">(</span><span class="token string">&quot;/test/device&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;5&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;CHECK_VALUE&quot;</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="функция-shadow-set-value"><a href="#функция-shadow-set-value" aria-hidden="true" class="header-anchor">#</a> Функция shadow_set_value()</h4> <p>Обновляет топик, устанавливая значение &quot;value&quot;, но не запускает event-скрипты, которые подписаны на этот топик.<br>
Использование: <code>shadow_set_value(topic, value)</code><br>
Ничего не возвращает.</p> <p>Данные, поступающие из драйверов или скриптов, могут обновлять значение топика в стандартном (standard) или теневом (shadow) режиме. В первом случае, отработают все скрипты, которые подписаны на изменения значения топика, во втором случае, значение будет изменено без запуска скриптов. При обновлении самим скриптом топика, на который он подписан, коллбек в скрипте вызываться не будет.</p> <h4 id="функция-get-value"><a href="#функция-get-value" aria-hidden="true" class="header-anchor">#</a> Функция get_value()</h4> <p>Получает значение и метаинформацию топика.<br>
Использование: <code>local value, update_time, type, tags = get_value(topic)</code><br>
Возвращает поля value, update_time, type, tags  </p> <h4 id="функция-bus-serialize"><a href="#функция-bus-serialize" aria-hidden="true" class="header-anchor">#</a> Функция bus_serialize()</h4> <p>Получает содержимое центральной шины (bus) в виде вложенной таблицы.<br>
Использование: <code>local table = bus_serialize(pattern)</code><br>
Возвращает таблицу. Если передана переменная &quot;pattern&quot;, то будет выбрана только часть таблицы, соответствующая заданному шаблону. Шаблоны соответствуют правилам <a href="https://www.lua.org/pil/20.2.html" target="_blank" rel="noopener noreferrer">lua patterns<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="вспомогатеnьные-функции"><a href="#вспомогатеnьные-функции" aria-hidden="true" class="header-anchor">#</a> Вспомогательные функции</h3> <h4 id="функция-round"><a href="#функция-round" aria-hidden="true" class="header-anchor">#</a> Функция round()</h4> <p>Функция для &quot;правильного&quot; математического округления с произвольной точностью.<br>
Получает число и количество знаков после запятой, возвращает округленное число. Если количество знаков не указано, используется 2.<br>
Использование: <code>local round_value = round(value, rounds)</code></p> <p>Примеры использования:</p> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token keyword">local</span> value <span class="token operator">=</span> <span class="token number">3.1415926535</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">round</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">--&gt; 3.14</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">round</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">--&gt; 3.14</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">round</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">--&gt; 3.142</span>
</code></pre></div><h4 id="функция-deepcopy"><a href="#функция-deepcopy" aria-hidden="true" class="header-anchor">#</a> Функция deepcopy()</h4> <p>Функция для копирования таблиц lua(если попытаться скопировать таблицу <code>table_a = table_b</code>, мы получим две ссылки на одну и ту же таблицу).<br>
Получает таблицу, возвращает копию таблицу. Таблица не должна быть рекурсивной, иначе функция переполнит стек.<br>
Использование: <code>local copy_table = deepcopy(table)</code></p> <p>Пример использования:</p> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token keyword">local</span> old_table <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">}</span>
<span class="token keyword">local</span> copy_table <span class="token operator">=</span> <span class="token function">deepcopy</span><span class="token punctuation">(</span>old_table<span class="token punctuation">)</span>
</code></pre></div><h3 id="встроенные-бибnиотеки"><a href="#встроенные-бибnиотеки" aria-hidden="true" class="header-anchor">#</a> Встроенные библиотеки</h3> <p>Для использования этих библиотек не нужно делать require, они уже есть в области видимости каждого скрипта.</p> <h4 id="бибnиотека-http-client"><a href="#бибnиотека-http-client" aria-hidden="true" class="header-anchor">#</a> Библиотека HTTP Client</h4> <p>Библиотека, реализующая примитивы для http-запросов.<br>
Уже созданный экземпляр доступен через объект <code>http_client</code>, т.е. для метода <code>request()</code> нужно вызвать <code>http_client.request()</code><br>
Пример использования:</p> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token keyword">local</span> r <span class="token operator">=</span> http_client<span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'http://google.com'</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
</code></pre></div><p><a href="https://www.tarantool.io/en/doc/1.9/reference/reference_lua/http/" target="_blank" rel="noopener noreferrer">Документация<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h4 id="бибnиотека-mqtt"><a href="#бибnиотека-mqtt" aria-hidden="true" class="header-anchor">#</a> Библиотека MQTT</h4> <p>Библиотека, реализующая клиента протокола MQTT. Доступна через объект <code>mqtt</code><br>
Пример использования:</p> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token keyword">local</span> mqtt_object <span class="token operator">=</span> mqtt<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;client_id&quot;</span><span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span>
mqtt_object<span class="token punctuation">:</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">{</span> host<span class="token operator">=</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">1883</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
ok<span class="token punctuation">,</span> err <span class="token operator">=</span> mqtt_object<span class="token punctuation">:</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">'my/topic/#'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
ok<span class="token punctuation">,</span> err <span class="token operator">=</span> mqtt_object<span class="token punctuation">:</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">'my/topic/#'</span><span class="token punctuation">,</span> <span class="token string">'Some payload as string'</span><span class="token punctuation">,</span> mqtt<span class="token punctuation">.</span>QOS_0<span class="token punctuation">,</span> mqtt<span class="token punctuation">.</span>RETAIN<span class="token punctuation">)</span>
</code></pre></div><p><a href="https://github.com/tarantool/mqtt" target="_blank" rel="noopener noreferrer">Документация<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h4 id="бибnиотека-json"><a href="#бибnиотека-json" aria-hidden="true" class="header-anchor">#</a> Библиотека JSON</h4> <p>Библиотека, конвертирующая таблицы lua в json и обратно. Доступна через объект <code>json</code><br>
Пример использования:</p> <div class="language-lua extra-class"><pre class="language-lua"><code>json<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">{</span>abc <span class="token operator">=</span> <span class="token number">234</span><span class="token punctuation">,</span> cde <span class="token operator">=</span> <span class="token number">345</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">--&gt; '{&quot;cde&quot;:345,&quot;abc&quot;:234}'</span>
json<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token string">'[123, &quot;hello&quot;]'</span><span class="token punctuation">)</span> <span class="token comment">--&gt; [123, 'hello']</span>
</code></pre></div><p><a href="https://www.tarantool.io/en/doc/1.9/reference/reference_lua/json/" target="_blank" rel="noopener noreferrer">Документация<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h4 id="бибnиотека-socket"><a href="#бибnиотека-socket" aria-hidden="true" class="header-anchor">#</a> Библиотека Socket</h4> <p>Библиотека для доступа к системным сокетам. Доступна через объект <code>socket</code><br>
Пример использования:</p> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token keyword">local</span> sock_1 <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token string">'AF_INET'</span><span class="token punctuation">,</span> <span class="token string">'SOCK_DGRAM'</span><span class="token punctuation">,</span> <span class="token string">'udp'</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> sock_2 <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token string">'AF_INET'</span><span class="token punctuation">,</span> <span class="token string">'SOCK_DGRAM'</span><span class="token punctuation">,</span> <span class="token string">'udp'</span><span class="token punctuation">)</span>
sock_1<span class="token punctuation">:</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">)</span>
sock_2<span class="token punctuation">:</span><span class="token function">sendto</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> sock_1<span class="token punctuation">:</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>port<span class="token punctuation">,</span><span class="token string">'X'</span><span class="token punctuation">)</span>
message <span class="token operator">=</span> sock_1<span class="token punctuation">:</span><span class="token function">recvfrom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token comment">--&gt; X</span>
</code></pre></div><p><a href="https://www.tarantool.io/en/doc/1.9/reference/reference_lua/socket/" target="_blank" rel="noopener noreferrer">Документация<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h4 id="бибnиотека-fiber"><a href="#бибnиотека-fiber" aria-hidden="true" class="header-anchor">#</a> Библиотека Fiber</h4> <p>Библиотека для работы с потоками. Доступна через объект <code>fiber</code><br>
Не стоит подключать библиотеку fiber вручную, т.е. делать &quot;local fiber = require 'fiber'&quot;.<br>
В этом случае, ошибки внутри тредов fiber не попадут в лог конкретного скрипта и не сгенерируют ошибку, что усложняет отладку.<br>
В библиотеке доступны методы <code>fiber.sleep()</code>, <code>fiber.create()</code>, <code>fiber.kill()</code>, <code>fiber.yield()</code>, <code>fiber.self()</code>, <code>fiber.status()</code>. Для остальных нужно делать require и оборачивать функции, которые запускаются через <code>fiber.create()</code> в <code>pcall()</code>/<code>xpcall()</code>.<br>
Пример использования:</p> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">while</span> <span class="token keyword">true</span> <span class="token keyword">do</span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;tick&quot;</span><span class="token punctuation">)</span>
      fiber<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1.2</span><span class="token punctuation">)</span> <span class="token comment">--seconds</span>
   <span class="token keyword">end</span>
<span class="token keyword">end</span>
fiber<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span>
</code></pre></div><p><a href="https://www.tarantool.io/en/doc/1.9/reference/reference_lua/fiber/" target="_blank" rel="noopener noreferrer">Документация<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="скрипты-и-драйвера"><a href="#скрипты-и-драйвера" aria-hidden="true" class="header-anchor">#</a> Скрипты и драйвера</h2> <h3 id="drivers"><a href="#drivers" aria-hidden="true" class="header-anchor">#</a> Drivers</h3> <p>Драйвера — это скрипты на Lua, которые реализуют тот или иной протокол(часто с привлечением сторонних библиотек) для связи с устройством, конвертируя данные приходящие с каждого устройства в единый формат. Они работают в качестве транслятора между &quot;языком&quot; устройства и общей шиной.<br> <br> <a href="/examples_driver.html">Примеры драйверов</a></p> <h3 id="bus-event-scripts"><a href="#bus-event-scripts" aria-hidden="true" class="header-anchor">#</a> Bus-event scripts</h3> <p>Этот тип скриптов выполняется для каждого устройства из группы устройств, определяемых маской, при обновлении их данных на центральной шине.<br> <img src="images/busEventScriptList.png" alt="Bus-event scripts" title="Bus-event scripts"></p> <p>В теле скрипта должна присутствовать функция <code>event_handler()</code>, в которую будет передано значение измененного топика и его адрес:</p> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token keyword">function</span> <span class="token function">event_handler</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> topic<span class="token punctuation">)</span>
   <span class="token function">print</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> topic<span class="token punctuation">)</span> <span class="token comment">--&gt; &quot;5 /test/device&quot;</span>
<span class="token keyword">end</span>
</code></pre></div><p>Также, в теле скрипта, можно создать функции <code>init()</code> и <code>destroy()</code>, которые будут вызваны при инициализации скрипта и его выгрузке соответственно.<br>
Это может быть полезно, например, если нужно сделать экспорт множества топиков по маске в MQTT.</p> <p>У Bus-event скриптов существует возможность однократного запуска нажатием кнопки <strong>&quot;Run Once&quot;</strong> на странице редактиования скрипта или на странице со списком скриптов.<br>
При однократном запуске, принудительно запускается <code>event_handler()</code> c аргументами <code>value=0</code>, <code>topic=&quot;once&quot;</code>. Не выполняются <code>init()</code> и <code>destroy()</code>.
Однократный запуск полезен для отладки и совершения разовых действий.</p> <p><a href="/examples_bus_event.html">Примеры bus-event скриптов</a></p> <h3 id="web-event-scripts"><a href="#web-event-scripts" aria-hidden="true" class="header-anchor">#</a> Web-event scripts</h3> <p>Скрипты, выполняемые при обращении к выбранному URL (&quot;endpoint&quot;) с помощью HTTP запроса.</p> <p><img src="images/webScriptsList.png" alt="Web-event scripts" title="Web-event scripts"></p> <p>Функция, реализующая непосредственную логику при обработке запроса — <code>http_callback()</code>.</p> <p>При создании web-event скрипта, необходимо дать ему название и указать endpoint.<br>
Полный адрес скрипта формируется как <code>адрес_сервера:порт</code> + <code>/we/</code> + <code>endpoint</code> и отображается в нижней части модального окна как &quot;Full script URL&quot;.</p> <p><img src="images/createWebEventScript.png" alt="Создание web-event скрипта" title="Создание web-event скрипта"></p> <p>В скриптах доступны переменные, содержащие данные запроса:</p> <ul><li><code>params</code> - массив с параметрами запроса</li> <li><code>req</code> - объект запроса <a href="https://github.com/tarantool/http" target="_blank" rel="noopener noreferrer">HTTP сервера Tarantool<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token keyword">function</span> <span class="token function">http_callback</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
   <span class="token keyword">return</span> <span class="token punctuation">{</span>data<span class="token operator">=</span>params<span class="token punctuation">}</span>
<span class="token keyword">end</span>
</code></pre></div><p>Если в функции <code>http_callback()</code> вернуть одно значение-таблицу (напр. <code>return table</code>), то она будет сериализована в JSON и в таком виде отдана клиенту http-сервера.<br>
Если необходимо управлять возвращаемыми данными напрямую, то надо вернуть 2 значения (напр. <code>return nil, 'OK'</code>), тогда первое значение будет отброшено, а второе - выдано клиенту в &quot;сыром&quot; виде без сериализации. Для дополнительных сведений смотрите документацию <a href="https://github.com/tarantool/http" target="_blank" rel="noopener noreferrer">HTTP сервера Tarantool<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="/examples_web_event.html">Примеры web-event скриптов</a></p> <h3 id="timer-event-scripts"><a href="#timer-event-scripts" aria-hidden="true" class="header-anchor">#</a> Timer-event scripts</h3> <p>Скрипты, выполняемые с определенным интервалом (указывается в секундах).</p> <p><img src="images/createTimerEventScript.png" alt="Timer-event script" title="Timer-event script"></p> <p>Для создания скрипта, укажите его название и желаемый интервал его выполнения в секундах.</p> <p>Код скрипта должен находиться внутри функции <code>event_handler()</code>.</p> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token keyword">function</span> <span class="token function">event_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;Timer event start&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
</code></pre></div><p><a href="/examples_timer_event.html">Примеры timer-event скриптов</a></p> <h3 id="schedule-scripts"><a href="#schedule-scripts" aria-hidden="true" class="header-anchor">#</a> Schedule scripts</h3> <p>Скрипты, выполняемые по заданному расписанию.</p> <p><img src="images/scheduleScript.png" alt="Schedule script" title="Schedule script"></p> <p>Для создания скрипта, укажите его название и расписание в формате <a href="https://en.wikipedia.org/wiki/Cron" target="_blank" rel="noopener noreferrer">crontab<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.<br>
Формат отличается от стандартного необходимостью указания секунд в интервале (первый символ). Если вам не нужны секунды, укажите в первом символе &quot;0&quot;. Не указываете там &quot;*&quot;, иначе скрипт будет запускаться каждую секунду в подходящих интервалах.</p> <div class="language- extra-class"><pre class="language-text"><code>┌───────────── секунды (0 - 59)
│ ┌───────────── минуты (0 - 59)
│ │ ┌───────────── часы (0 - 23)
│ │ │ ┌───────────── дни месяца (1 - 31)
│ │ │ │ ┌───────────── месяца (JAN-DEC или 1 - 12)
│ │ │ │ │ ┌───────────── день недели (SUN-SAT или 0 - 6) (с воскресения до субботы)
│ │ │ │ │ │
│ │ │ │ │ │
* * * * * *
</code></pre></div><p>К примеру, с такими настройками расписания, скрипт будет запускаться по четвергам в 13:45:15</p> <div class="language- extra-class"><pre class="language-text"><code> 15 45 13 * * 4
</code></pre></div><p>Код скрипта должен находиться внутри функции <code>event_handler()</code>.</p> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token keyword">function</span> <span class="token function">event_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;Shedule event start&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
</code></pre></div><p><a href="/examples_shedule_event.html">Примеры shedule-event скриптов</a></p></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">9/25/2018, 3:32:06 PM</span></div></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/6.e7415cd1.js" defer></script><script src="/assets/js/app.a697d354.js" defer></script>
  </body>
</html>
